---
description: 
globs: 
alwaysApply: true
---
# DB Schema
## This is our current db schema
### is might be out of date so you can use the MCP tool to confirm the schema
```sql

CREATE TABLE public.user\_profiles (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	apple_id TEXT UNIQUE,
	email TEXT,
	name TEXT,
	avatar_url TEXT,
	is_premium BOOLEAN DEFAULT FALSE,
	premium_until TIMESTAMPTZ,
	created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
	updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE public.user\_progress (
	id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
	user_id UUID REFERENCES user_profiles(id) ON DELETE CASCADE,
	streak INTEGER DEFAULT 0,
	routine_completions INTEGER DEFAULT 0,
	total_minutes INTEGER DEFAULT 0,
	last_activity DATE,
	created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
	updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- 4. Add indexes for performance
CREATE INDEX idx\_user\_progress\_user\_id ON user\_progress(user\_id);


-- 5. Enable Row Level Security
ALTER TABLE user\_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE user\_progress ENABLE ROW LEVEL SECURITY;

-- 6. Add RLS Policies
-- User Profiles: Users can only view and modify their own profile
CREATE POLICY "Users can view own profile"
ON user\_profiles FOR SELECT
TO authenticated
USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile"
ON user\_profiles FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile"
ON user\_profiles FOR UPDATE
TO authenticated
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- User Progress: Users can only view and modify their own progress
CREATE POLICY "Users can view own progress"
ON user\_progress FOR SELECT
TO authenticated
USING (auth.uid() = user\_id);

CREATE POLICY "Users can insert own progress"
ON user\_progress FOR INSERT
TO authenticated
WITH CHECK (auth.uid() = user\_id);

CREATE POLICY "Users can update own progress"
ON user\_progress FOR UPDATE
TO authenticated
USING (auth.uid() = user\_id)
WITH CHECK (auth.uid() = user\_id);
```
